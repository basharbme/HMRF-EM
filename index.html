<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>HMRF-EM by tanyanair</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">HMRF-EM</h1>
      <h2 class="project-tagline">A MATLAB implementation of a Hidden Markov Random Field Model (HMRF) optimized with Expectation Maximization used to segment 3D MR images from the OASIS-brains dataset. </h2>
      <a href="https://github.com/tanyanair/HMRF-EM" class="btn">View on GitHub</a>
      <a href="https://github.com/tanyanair/HMRF-EM/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/tanyanair/HMRF-EM/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="segmentation-of-3d-images-using-the-hidden-markov-random-field-model-hmrf-and-expectation-maximization-algorithm-em" class="anchor" href="#segmentation-of-3d-images-using-the-hidden-markov-random-field-model-hmrf-and-expectation-maximization-algorithm-em" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Segmentation of 3D images using the Hidden Markov Random Field Model (HMRF) and Expectation-Maximization Algorithm (EM)</h2>

<p>A MATLAB implementation of the HMRF as described in "Segmentation of Brain MR Images Through a Hidden Markov Random Field Model and the Expectation-Maximization Algorithm" [8]. The HMRF is applied to segment images from the cross-sectional OASIS-brains dataset but the code provided can be modified for any 3D image segmentation.</p>

<p>In the next couple of sections, I'll introduce the problem of tissue segmentation and classification in medical imaging, desribe the high level segmentation pipeline, mathematical modelling of the HMRF, the optimization through EM, as well as an implementation of the model applied to white matter, grey matter, and cerebrospinal fluid (CSF). If you're not interested in this long discussion and are looking for a quick read about the HMRF model, what my code does, and what can use this code for, skip to the end of this page to "HMRF 101" section.</p>

<h3>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction</h3>

<p>Tissue segmentation and classification is a pressing challenge within the field of medical imaging. The ability to precisely classify tissues allows for quantitative analyses of substructures that are correlated with disease evolution. For example, Alzheimer's Disease can be characterized by atrophy in otherwise healthy white matter and gray matter brain tissue.</p>

<p>When examining tissue in the brain, Magnetic Resonance Imaging (MRI) is the predominant imaging technique of choice as it is non-invasive and provides excellent soft tissue contrast. Additionally, advances in MRI technology have enabled the acquisition of high resolution images across different modalities that provide differing contrasts for sub-tissue categories. Alongside these advances come the need for automated methods to reduce the time and economic costs associated with manual segmentation (which is performed by expertly trained radiologists). Automated techniques can also address inter and intra-human error that persists despite standardized protocols and training procedures.</p>

<p>Automated brain MR tissue segmentation is a non-trivial problem for a number of reasons. Non-homogeneities induced by the scanning technology limit the efficacy of intensity based classifiers; multi-modal information from different scan procedures has to be aggregated; and when segmenting pathology, the non-deterministic size, shape, and location of abnormalities provide additional challenges. Integrating local context into tissue classification models is one tool used to overcome some of these challenges. For this reason, Markov Random Fields (MRFs) have been widely used in the literature. MRFs integrate spatial information into the segmentation process in a probabilistic way such that the classification of a voxel becomes statistically dependent on its neighbouring pixels. </p>

<p>MRF models applied to brain MR segmentation prior to the work of Zhang et al. had two key limitations [8]. They either did not have a parameter fitting step (as in [3]), or the parameter estimation step was limited by the finite mixture model being employed. These models, such as the Gaussian Mixture Model in [7], are employed as mathematically convenient approximations, which are not statistically grounded. Furthermore, finite models operate best under low noise conditions, which is a poor assumption in real MR images where bias fields and partial volume effects distort within-class voxel intensities. This is pointed out by Zhang et al. in [8], who are thus motivated to develop a hidden MRF (HMRF) to model tissue intensities. Using a HMRF allows for the integration of spatial dependences into the tissue intensity model (which were previously modelled separately). A hidden Markov model is a statistical process generated by a Markov chain where the state (ie. tissue class) is not observable, but the output (ie. voxel intensity) is observed and is probabilistically conditioned on the input state. In [8] this concept is extended to a 3D HMRF whereby the source is a MRF describing the voxel intensities in the brain image. The authors use a Gaussian distribution to describe the observed random field, and use Expectation-Maximization (EM) to fit their HMRF model parameters on simulated images of non-diseased tissue to segment white matter (WM), gray matter (GM), and cerebrospinal fluid (CSF). </p>

<p>This paper describes the high level segmentation pipeline, followed by the mathematical modelling of the HMRF, the optimization through EM, as well as an implementation of the model applied to WM, GM, CSF segmentation of 416 brains in the OASIS cross-sectional dataset. Experimental results are given characterizing the performance against the FAST-FSL implementation, followed by a discussion of the strengths and weaknesses of the model.</p>

<h3>
<a id="model-description" class="anchor" href="#model-description" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Model Description</h3>

<p>For each image, an initial segmentation is performed using Otsu thresholding. With this initial segmentation, the HMRF model parameters are calculated for each tissue class (GM/WM/CSF). These parameters are fed into an EM routine which iteratively calculates MRF-MAP tissue labels for each voxel, and then (in the maximization step), updates the HMRF mean, and variance parameters for each class. This continues until the EM stopping criteria has been met.</p>

<h4>
<a id="initial-segmentation" class="anchor" href="#initial-segmentation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Initial Segmentation</h4>

<p>Because EM guarantees convergence to a local optimum, the initial segmentation is a critical stage of the algorithm. Zhang et al. employ Otsu thresholding as described in [6] to obtain the initial segmentation. Otsu thresholding seeks to find the thresholds that minimize intra-class (within-class) variance. The core underlying assumption is that the intensity histogram of the image will follow a trimodal distribution, which as shown in Figure  is upheld.
<img src="images/histbrain.png" alt="Intensity Histogram of Brain MR-T1 Image"></p>

<h4>
<a id="hmrf-model" class="anchor" href="#hmrf-model" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HMRF Model</h4>

<h5>
<a id="mrf-theory" class="anchor" href="#mrf-theory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MRF Theory</h5>

<h5>
<a id="hmrf-theory" class="anchor" href="#hmrf-theory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HMRF Theory</h5>

<h4>
<a id="mrf-map-classification" class="anchor" href="#mrf-map-classification" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MRF-MAP Classification</h4>

<h5>
<a id="minimization-of-posterior-energy" class="anchor" href="#minimization-of-posterior-energy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Minimization of Posterior Energy</h5>

<h4>
<a id="maximum-likelihood-parameter-updates" class="anchor" href="#maximum-likelihood-parameter-updates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Maximum Likelihood Parameter Updates</h4>

<h3>
<a id="experimental-implementation" class="anchor" href="#experimental-implementation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Experimental Implementation</h3>

<h3>
<a id="results" class="anchor" href="#results" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Results</h3>

<h3>
<a id="discussion" class="anchor" href="#discussion" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Discussion</h3>

<h2>
<a id="hmrf-101" class="anchor" href="#hmrf-101" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HMRF 101</h2>

<h3>
<a id="what-is-a-mrf-and-why-would-i-need-one" class="anchor" href="#what-is-a-mrf-and-why-would-i-need-one" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What is a MRF and why would I need one?</h3>

<p>Great question! Before we talk about HMRF's, we need to take a few steps back and talk about Markov Random Fields (MRF's). MRFs are a powerful statistical tool that are exploited in image segmentation applications to provide spatial context into generative models. Work prior to Zhang et al. in 2001 used MRFs as priors in finite mixture models that model tissue intensities (ie. GMM's) or in non-parametric models (ie. Parzen Windows). However, the simplifications made in these models come from mathematical convenience, as opposed to a statistical foundation. Using a HMRF to explicitly model the tissue intensities avoids these assumptions since the spatial relationships are built into the model. The paper ([8]) is a landmark in the field of brain tissue segmentation, but the model can be extended across any domain where capturing local spatial relationships is important to the segmentation task.</p>

<h3>
<a id="what-can-i-test-this-algorithm-on" class="anchor" href="#what-can-i-test-this-algorithm-on" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What can I test this algorithm on?</h3>

<p>Short answer - any 3D image. I validated the model using the OASIS- Cross-sectional dataset. This dataset consists of 416 normal and early onset Alzheimer Disease subjects from ages 18-96. Ground truth labels are provided in the dataset - which come from the FAST-FSL implementation of the HMRF described in the paper. This </p>

<h3>
<a id="what-does-my-code-do" class="anchor" href="#what-does-my-code-do" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What does my code do?</h3>

<ol>
<li>Obtain an initial estimate of the HMRF parameters from an initial segmentation (Otsu or Kmeans).</li>
<li>Calculate likelihood distribution of the intensity data given the bias field and the initial tissue classification.</li>
<li>Obtain tissue class estimates using MRF-MAP criteria (using the ICM algorithm).</li>
<li>Calculate the conditional probability distribution of each class given the intensity values of that class.</li>
<li>Update the HMRF parameters for each class.</li>
<li>Repeat steps 2-5 until convergence.</li>
</ol>

<h3>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors and Contributors</h3>

<p>Tanya Nair (<a href="https://github.com/tanyanair" class="user-mention">@tanyanair</a>)</p>

<h3>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>References</h3>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/tanyanair/HMRF-EM">HMRF-EM</a> is maintained by <a href="https://github.com/tanyanair">tanyanair</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
